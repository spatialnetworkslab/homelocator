---
title: "Homelocator Method"
date: '`r format(Sys.time(), "%d %B, %Y")`'
output: 
  html_document:
    toc: true 
    toc_depth: 4  
    number_sections: true  
    theme: united  
    highlight: tango  
    toc_float: true   
    code_folding: hide
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

```{r load_library, message=FALSE, warning=FALSE}
library(homelocator)
library(dplyr)
library(tidyverse)
library(readr)
```

```{r load_data, message=FALSE, warning=FALSE}
if (file.exists(here::here("data/lexington2012_2017.rds"))) {
   df <- readRDS(here::here("data/lexington2012_2017.rds"))
 } else {
   df <- read_csv(here::here("data/lexington-with-GEOID-2012-2017.csv")) %>% 
     select(c(u_id, GEOID, created_at)) %>% 
     mutate(u_id = as.character(u_id),
            GEOID = as.character(GEOID))
   saveRDS(df, here::here("data/lexington2012_2017.rds"))  # save to rds 
 }

df <- derive_timestamp(df, created_at)

# nest data 
df_nest <- nest_dataframe(df, u_id)
head(df_nest)
```

```{r data_filtering, message=FALSE, warning=FALSE}
qq_filtered <- df_nest %>% 
  summarise_var(counts_per_user = n(), 
                distinct_loc_per_user = n_distinct(GEOID)) %>% 
  filter_var(counts_per_user > 10) %>% 
  filter_var(distinct_loc_per_user > 10) %>% 
  summarise_groupVar(vars(GEOID), 
                     vars(counts_per_loc = n(), 
                          distinct_hour_per_loc = n_distinct(hour_of_day), 
                          distinct_day_per_loc = n_distinct(date), 
                          time_period_per_loc = as.numeric(max(created_at) - min(created_at), "days"))) %>% 
  filter_var(counts_per_loc > 10) %>% 
  filter_var(distinct_hour_per_loc > 10) %>% 
  filter_var(distinct_day_per_loc > 10) %>% 
  filter_var(time_period_per_loc > 10) %>% 
  arrange_var(counts_per_user) %>% 
  remove_bots(top_user_percent = 0.1) 
head(qq_filtered)
```

```{r data_expanded, message=FALSE, warning=FALSE}
qq_expanded <- qq_filtered %>% 
  add_col(week = if_else(day_of_week %in% c(1,7), 1, 2)) %>%  # 1 for weekend, 2 for weekday 
  add_col(numeric_time = lubridate::hour(created_at) + lubridate::minute(created_at) / 60 + lubridate::second(created_at) / 3600) %>% 
  add_col(rest_or_work = if_else(numeric_time >= 9 & numeric_time <= 18, 2, 1)) %>% # 1 for rest time, 2 for work time 
  add_col(early_or_late = if_else(numeric_time >= 6 & numeric_time <= 12, 1, 2)) # 1 for early morning, 2 for late afternoon and night 
```


```{r data_score, message=FALSE, warning=FALSE}
qq_scored <- qq_expanded %>% 
  nest_dataframe(u_id) %>% 
  summarise_var(distinct_day_of_week = n_distinct(day_of_week), 
                    distinct_month = n_distinct(month)) %>% 
  summarise_groupVar(vars(week), vars(counts_week = n())) %>% 
  add_groupCol(vars(u_id), vars(percent_week = counts_week/sum(counts_week))) %>% 
  nest_dataframe(u_id) %>% 
  summarise_groupVar(vars(rest_or_work), vars(counts_rest_or_work = n())) %>% 
  add_groupCol(vars(u_id), vars(percent_rest_or_work = counts_rest_or_work/sum(counts_rest_or_work))) %>% 
  nest_dataframe(u_id) %>% 
  filter_nest(rest_or_work == 1 & percent_rest_or_work >= 0.5) %>% 
  score_user(u_id, score_counts_per_loc = 0.1 * (counts_per_loc/max(counts_per_loc))) %>% 
  score_user(u_id, score_distinct_hour_per_loc = 0.1 * (distinct_hour_per_loc/24)) %>% 
  score_user(u_id, score_distinct_day_per_loc = 0.1 * (distinct_day_per_loc/max(distinct_day_per_loc))) %>% 
  score_user(u_id, score_time_period_per_loc = 0.1 * (time_period_per_loc/max(as.numeric(time_period_per_loc)))) %>% 
  score_user(u_id, score_percent_week = 0.2 * (time_period_per_loc)) %>% 
  score_user(u_id, score_percent_rest_or_work = 0.2 * (percent_rest_or_work)) %>% 
  score_user(u_id, score_distinct_day_of_week = 0.1 * (distinct_day_of_week/7)) %>% 
  score_user(u_id, score_distinct_month = 0.1 * (distinct_month)) %>% 
  sum_score(u_id, GEOID, score_counts_per_loc, score_distinct_hour_per_loc, score_distinct_day_per_loc, score_time_period_per_loc, score_percent_week, score_percent_rest_or_work, score_distinct_day_of_week, score_distinct_month)
```

```{r home_extract, message=FALSE, warning=FALSE}
home_qq <- qq_scored %>%
  nest_dataframe(u_id) %>% 
  extract_home(score > 0, score)
head(home_qq)
#write_csv(home_qq, path = "result_qingqing.csv")
```

