---
title: "Homelocator Method"
date: '`r format(Sys.time(), "%d %B, %Y")`'
output: 
  html_document:
    toc: true 
    toc_depth: 4  
    number_sections: true  
    theme: united  
    highlight: tango  
    toc_float: true   
    code_folding: hide
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

```{r load_library, message=FALSE, warning=FALSE}
library(homelocator)
```

```{r load_data, message=FALSE, warning=FALSE}
df <- read_csv("/Users/qingqing/Dropbox/SUTD/Ate/homelocator/data/lexington-with-GEOID-2012-2017.csv") %>% 
  select(c(id, u_id, GEOID, created_at)) 

df <- df %>% 
  derive_timestamp(created_at)

# nest data 
df_nest <- df %>% 
  group_by(u_id) %>% 
  nest(.key = user_data)
head(df_nest)
```

```{r data_filtering, message=FALSE, warning=FALSE}
df_filtered <- df_nest %>% 
  summarise_by_user(counts_per_user = n(), 
                    distinct_loc_per_user = n_distinct(GEOID)) %>% 
  filter_var(counts_per_user > 10) %>% 
  filter_var(distinct_loc_per_user > 10) %>% 
  summarise_by_groups(vars(GEOID), 
                      vars(counts_per_loc = n(), 
                           distinct_hour_per_loc = n_distinct(hour_of_day), 
                           distinct_day_per_loc = n_distinct(date), 
                           time_period_per_loc = as.numeric(max(created_at) - min(created_at), "days"))) %>% 
  filter_var(counts_per_loc > 10) %>% 
  filter_var(distinct_hour_per_loc > 10) %>% 
  filter_var(distinct_day_per_loc > 10) %>% 
  filter_var(time_period_per_loc > 10) %>% 
  arrange_var(counts_per_user) %>% 
  remove_top_n(top_user_percent = 0.1) %>% 
  unnest()
head(df_filtered)
```

```{r data_expanded, message=FALSE, warning=FALSE}
df_expanded <- df_filtered %>% 
  add_column(week = if_else(day_of_week %in% c(1,7), 1, 2)) %>%  # 1 for weekend, 2 for weekday 
  add_column(numeric_time = lubridate::hour(created_at) + lubridate::minute(created_at)/60 + lubridate::second(created_at) / 3600) %>% 
  add_column(time_frame = if_else(numeric_time >= 9 & numeric_time <= 18, 2, 1)) %>% # 1 for rest time, 2 for work time 
  add_column(morning_time = if_else(numeric_time >= 6 & numeric_time <= 12, 1, 2)) # 1 for morning, 2 for afternoon and night 
```

```{r data_score, message=FALSE, warning=FALSE}
df_scored <- df_expanded %>% 
  group_by(u_id) %>% 
  nest(.key = user_data) %>% 
  summarise_by_user(distinct_day_of_week = n_distinct(day_of_week), 
                    distinct_month = n_distinct(month)) %>% 
  summarise_by_groups(vars(week), 
                      vars(counts_week = n())) %>% 
  add_column_by_group(vars(u_id), 
                      vars(percent_week = counts_week/sum(counts_week))) %>% 
  summarise_by_groups(vars(time_frame), 
                      vars(counts_time_frame = n())) %>% 
  add_column_by_group(vars(u_id),
                      vars(percent_time_frame = counts_time_frame/sum(counts_time_frame))) %>% 
  calcu_score_by_user(score_counts_per_loc = 0.1 * (counts_per_loc/max(counts_per_loc))) %>% 
  calcu_score_by_user(score_distinct_hour_per_loc = 0.1 * (distinct_hour_per_loc/24)) %>% 
  calcu_score_by_user(score_distinct_day_per_loc = 0.1 * (distinct_day_per_loc/max(distinct_day_per_loc))) %>% 
  calcu_score_by_user(score_time_period_per_loc = 0.1 * (time_period_per_loc/max(as.numeric(time_period_per_loc)))) %>% 
  calcu_score_by_user(score_percent_week = 0.2 * (time_period_per_loc)) %>% 
  calcu_score_by_user(score_percent_time_frame = 0.2 * (percent_time_frame)) %>% 
  calcu_score_by_user(score_distinct_day_of_week = 0.1 * (distinct_day_of_week/7)) %>% 
  calcu_score_by_user(score_distinct_month = 0.1 * (distinct_month)) %>% 
  unnest() %>% 
  add_column(score = rowSums(.[, c("score_counts_per_loc", "score_distinct_hour_per_loc","score_distinct_day_per_loc","score_time_period_per_loc", "score_percent_week", 
                                             "score_percent_time_frame", "score_distinct_day_of_week", "score_distinct_month")]))
```

```{r home_extract, message=FALSE, warning=FALSE}
home_qq <- df_scored %>% 
  group_by(u_id) %>% 
  nest(.key = user_data) %>% 
  extract_home(score > 0, score)
head(df_home)
write_csv(home_qq, path = "result_qingqing.csv")
```

