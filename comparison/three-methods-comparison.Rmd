---
title: "Three method comparison"
date: '`r format(Sys.time(), "%d %B, %Y")`'
output: 
  html_document:
    toc: true 
    toc_depth: 4  
    number_sections: true  
    theme: united  
    highlight: tango  
    toc_float: true   
    code_folding: hide
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

```{r warning=FALSE, message=FALSE, echo=FALSE}
library(tidyverse)
library(sf)
library(tidycensus)
library(furrr)
source(here::here("comparison/function_three_compare.R"))
```

```{r load_three_results, message=FALSE, warning=FALSE}
if (file.exists(here::here("data/lexington2012_2017.rds"))) {
   df <- readRDS(here::here("data/lexington2012_2017.rds"))
 } else {
   df <- read_csv(here::here("data/lexington-with-GEOID-2012-2017.csv")) %>% 
     select(c(u_id, GEOID, created_at)) %>% 
     mutate(u_id = as.character(u_id),
            GEOID = as.character(GEOID))
   saveRDS(df, here::here("data/lexington2012_2017.rds"))  # save to rds 
 }

df_qq <- read_result("result_qingqing.csv")
df_efs <- read_result("result_efstathiades.csv") 
df_ahas <- read_result("result_ahas.csv") 
```


```{r qq_vs_efs, message=FALSE, warning=FALSE}
sameRes_efs_qq <- commonRes_detect(df_qq, df_efs)
diffRes_efs_qq <- diffRes_detect(df_qq, df_efs, df, acs_ky) %>% 
  mutate(homeloc = if_else(homeloc == "homeloc_df1", "home_qq", "home_efs"))
# write_csv(sameRes_efs_qq, path = "/Users/qingqing/Dropbox/SUTD/Ate/homelocator/inst/extdata/sameRes_efs_qq.csv")
# write_csv(diffRes_efs_qq, path = "/Users/qingqing/Dropbox/SUTD/Ate/homelocator/inst/extdata/diffRes_efs_qq.csv")
```

```{r qq_vs_ahas, message=FALSE, warning=FALSE}
sameRes_ahas_qq <- commonRes_detect(df_qq, df_ahas)
diffRes_ahas_qq <- diffRes_detect(df_qq, df_ahas, df, acs_ky) %>% 
  mutate(homeloc = if_else(homeloc == "homeloc_df1", "home_qq", "home_ahas"))
# write_csv(sameRes_ahas_qq, path = "/Users/qingqing/Dropbox/SUTD/Ate/homelocator/inst/extdata/sameRes_ahas_qq.csv")
# write_csv(diffRes_ahas_qq, path = "/Users/qingqing/Dropbox/SUTD/Ate/homelocator/inst/extdata/diffRes_ahas_qq.csv")
```

```{r efs_vs_ahas, message=FALSE, warning=FALSE}
sameRes_ahas_efs <- commonRes_detect(df_efs, df_ahas)
diffRes_ahas_efs <- diffRes_detect(df_efs, df_ahas, df, acs_ky) %>% 
  mutate(homeloc = if_else(homeloc == "homeloc_df1", "home_efs", "home_ahas"))
# write_csv(sameRes_ahas_efs, path = "/Users/qingqing/Dropbox/SUTD/Ate/homelocator/inst/extdata/sameRes_ahas_efs.csv")
# write_csv(diffRes_ahas_efs, path = "/Users/qingqing/Dropbox/SUTD/Ate/homelocator/inst/extdata/diffRes_ahas_efs.csv")
```


```{r efs_ahas_qq, message=FALSE, warning=FALSE}
sameRes_ahas_efs_qq <- commonRes_detect(sameRes_efs_qq, df_ahas)
df_same_three <- plyr::join_all(list(df_qq, df_efs, df_ahas), by = c("u_id", "homeloc"), type = 'inner')
# write_csv(sameRes_ahas_efs_qq, path = "/Users/qingqing/Dropbox/SUTD/Ate/homelocator/inst/extdata/sameRes_ahas_efs_qq.csv")
# write_csv(df_same_three, path = "/Users/qingqing/Dropbox/SUTD/Ate/homelocator/inst/extdata/df_same_three.csv")
# diffRes_ahas_efs_qq <- diffRes_detect(sameRes_efs_qq, df_ahas, df, acs_ky)
```

```{r view_diff_efs_qq, message=FALSE, warning=FALSE}
library(tmap)
tmap_mode("view")
#tmap_mode("plot")
#ttm()

diff_users_efs_qq <- diffRes_efs_qq$u_id %>% unique()
# SELECT some users to show the results
plot1_users <- diff_users_efs_qq %>% 
  as_data_frame() %>% 
  mutate(id = 1:nrow(.)) %>% 
  filter(id %in% c(1, 8, 33, 37, 41, 42)) %>% 
  #filter(id %in% c(4, 9, 8, 10, 45, 24)) %>% 
  pull(value)

plot2_users <- diff_users_efs_qq %>% 
  as_data_frame() %>% 
  mutate(id = 1:nrow(.)) %>% 
  filter(id %in% c(5, 7, 9, 11, 17, 23)) %>% 
  pull(value)

## neighbouring  
view_diffUsers(diffRes_efs_qq, plot1_users)
## non-neighbouring 
view_diffUsers(diffRes_efs_qq, plot2_users)
```

```{r view_diff_ahas_qq, message=FALSE, warning=FALSE}
diff_users_ahas_qq <- diffRes_ahas_qq$u_id %>% unique()
# SELECT some users to show the results
plot3_users <- diff_users_ahas_qq %>% 
  as_data_frame() %>% 
  mutate(id = 1:nrow(.)) %>% 
  filter(id %in% c(2, 5, 8, 12, 13, 17)) %>% 
  pull(value)

plot4_users <- diff_users_ahas_qq %>% 
  as_data_frame() %>% 
  mutate(id = 1:nrow(.)) %>% 
  filter(id %in% c(1, 6, 7, 9, 15, 19)) %>% 
  pull(value)
## neighbor 
view_diffUsers(diffRes_ahas_qq, plot3_users)
## non-neighbor 
view_diffUsers(diffRes_ahas_qq, plot4_users)
```














