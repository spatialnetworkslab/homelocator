---
title: "Three method comparison"
date: '`r format(Sys.time(), "%d %B, %Y")`'
output: 
  html_document:
    toc: true 
    toc_depth: 4  
    number_sections: true  
    theme: united  
    highlight: tango  
    toc_float: true   
    code_folding: hide
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

```{r library}
library(tidyverse)
library(sf)
library(tidycensus)
library(furrr)
source("/Users/qingqing/Dropbox/SUTD/Ate/homelocator/comparison/function_three_compare.R")
```

```{r load_three_results}
df <- read_csv("/Users/qingqing/Dropbox/SUTD/Ate/homelocator/data/lexington-with-GEOID-2012-2017.csv") %>% 
  select(c(id, u_id, created_at, GEOID)) %>% 
  mutate(GEOID = as.character(GEOID))
df_qq <- read_csv("result_qingqing.csv") %>% 
  separate(homeloc, c("homeloc_1", "homeloc_2"), "; ") %>% 
  gather(homeloc, GEOID, c(homeloc_1, homeloc_2)) %>% 
  select(u_id, GEOID) %>% 
  setNames(c("u_id", "homeloc")) %>% 
  na.omit()
df_efs <- read_csv("result_efstathiades_homeloc.csv") %>% 
  setNames(c("u_id", "homeloc")) %>% 
  mutate(homeloc = as.character(homeloc))
df_ahas <- read_csv("result_ahas.csv") %>% 
  select(u_id, GEOID) %>% 
  mutate(GEOID = as.character(GEOID)) %>% 
  setNames(c("u_id", "homeloc"))
```


```{r qq_vs_efs, message=FALSE, warning=FALSE}
sameRes_efs_qq <- commonRes_detect(df_qq, df_efs)
diffRes_efs_qq <- diffRes_detect(df_qq, df_efs, df, acs_ky) %>% 
  mutate(homeloc = if_else(homeloc == "homeloc_df1", "home_qq", "home_efs"))
```

```{r qq_vs_ahas, message=FALSE, warning=FALSE}
sameRes_ahas_qq <- commonRes_detect(df_qq, df_ahas)
diffRes_ahas_qq <- diffRes_detect(df_qq, df_ahas, df, acs_ky) %>% 
  mutate(homeloc = if_else(homeloc == "homeloc_df1", "home_qq", "home_ahas"))
```

```{r efs_vs_ahas, message=FALSE, warning=FALSE}
sameRes_ahas_efs <- commonRes_detect(df_efs, df_ahas)
diffRes_ahas_efs <- diffRes_detect(df_efs, df_ahas, df, acs_ky) %>% 
  mutate(homeloc = if_else(homeloc == "homeloc_df1", "home_efs", "home_ahas"))
```


```{r efs_ahas_qq, message=FALSE, warning=FALSE}
sameRes_ahas_efs_qq <- commonRes_detect(sameRes_efs_qq, df_ahas)
df_same_three <- plyr::join_all(list(df_qq, df_efs, df_ahas), by = c("u_id", "homeloc"), type = 'inner')
# diffRes_ahas_efs_qq <- diffRes_detect(sameRes_efs_qq, df_ahas, df, acs_ky)
```

```{r view_diff_efs_qq, message=FALSE, warning=FALSE}
library(tmap)
tmap_mode("view")
#tmap_mode("plot")
#ttm()

diff_users_efs_qq <- diffRes_efs_qq$u_id %>% unique()
# SELECT some users to show the results
plot1_users <- diff_users_efs_qq %>% 
  as_data_frame() %>% 
  mutate(id = 1:nrow(.)) %>% 
  filter(id %in% c(4, 6, 49, 38, 45, 48)) %>% 
  pull(value)
plot2_users <- diff_users_ahas_qq %>% 
  as_data_frame() %>% 
  mutate(id = 1:nrow(.)) %>% 
  filter(id %in% c(1, 2, 3, 7, 13, 19)) %>% 
  pull(value)
view_diffUsers(diffRes_efs_qq, plot1_users)
view_diffUsers(diffRes_efs_qq, plot2_users)

# view_diffUsers <- function(df_diff, user_id){
#   df <- df_diff %>% 
#     left_join(., acs_ky) %>% 
#     st_as_sf
#   df %>% 
#     filter(u_id == user_id) %>% 
#     tm_shape() + 
#     tm_fill("n_tweets") + 
#     tm_text("homeloc", col = "black") + 
#     tm_borders() + 
#     tm_facets(by = "u_id")
#   # + 
#   #   tm_legend(position = c("left", "bottom"))
# }
# view_diffUsers(diffRes_efs_qq, diff_users[2])
```

```{r view_diff_ahas_qq, message=FALSE, warning=FALSE}
diff_users_ahas_qq <- diffRes_ahas_qq$u_id %>% unique()
# SELECT some users to show the results
plot3_users <- diff_users_ahas_qq %>% 
  as_data_frame() %>% 
  mutate(id = 1:nrow(.)) %>% 
  filter(id %in% c(3, 13, 14, 17, 29, 30)) %>% 
  pull(value)
plot4_users <- diff_users_ahas_qq %>% 
  as_data_frame() %>% 
  mutate(id = 1:nrow(.)) %>% 
  filter(id %in% c(16, 19, 22, 23, 25, 36)) %>% 
  pull(value)
view_diffUsers(diffRes_ahas_qq, plot3_users)
view_diffUsers(diffRes_ahas_qq, plot4_users)
```














