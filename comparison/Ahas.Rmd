---
title: "Ahas Method"
date: '`r format(Sys.time(), "%d %B, %Y")`'
output: 
  html_document:
    toc: true 
    toc_depth: 4  
    number_sections: true  
    theme: united  
    highlight: tango  
    toc_float: true   
    code_folding: hide
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r load_library}
library(tidyverse)
library(magrittr)
library(sf)
library(lubridate)
library(furrr)
library(gridExtra)
library(tidycensus)
source("function_Ahas.R")
options(future.globals.maxSize= 1073741824)
```

# Load data
```{r load_data, message=FALSE, warning=FALSE}
df <- read_data("lexington-with-GEOID-2012-2017.csv")
options(tigris_use_cache = TRUE, tigris_class="sf")
st_queen <- function(a, b = a) st_relate(a, b, pattern = "F***T****")
census_api_key("2fcf1623c436882ad5e62a47280ab732d815e363")
acs_ky <- tidycensus::get_acs(state = "KY", geography = "tract",
                  variables = c(medincome = "B19013_001"),
                  geometry = T, output = "wide", year = 2016)  %>%
                  st_transform(., "+init=epsg:4326") %>% 
    select(GEOID) %>% 
    mutate(id = 1:nrow(.))
neighbors <- st_queen(acs_ky)
```

# Data cleanning 
```{r step1and2, message=FALSE, warning=FALSE}
## Get regular cells , remove too low users, remove top 1% users 
regular_cells <- df %>% 
  get_RegularCells() %>% # keep regular cells 
  filter(!u_id %in% remove_lowUsers(.)) %>% # remove too low users 
  filter(!u_id %in% remove_highUsers(.))  # remove too high uers
```


```{r step3, message=FALSE, warning=FALSE}
#Determing home and work-time Anchor Points: the two regular locations that had the highest number of days with tweets are selected for the calculation of home and work-time anchor points, and the rest are moved directly to the last stages of the model, where they are called seconday anchor points.
singleAnchor <- regular_cells %>% 
  detect_singleAnchor() %>% 
  select(u_id, GEOID, loc) %>% 
  mutate(type = rep("one type, single anchor", nrow(.)))

df_multi <- regular_cells %>% filter(!u_id %in% singleAnchor$u_id)
multiAnchors <- df_multi %>% 
  group_by(u_id) %>% 
  nest() %>% 
  mutate(results = future_map(data, detect_multiAnchor)) %>% 
  select(-data) %>% 
  unnest() %>% 
  left_join(., df_multi) %>% 
  unite(date, year, month, day, sep = "-") %>% 
  select(-id, -created_at, -n_day_permonth) %>% 
  group_by(u_id) %>% 
  nest() %>% 
  mutate(results = future_map(data, decide_multiAnchor)) %>% 
  select(-data) %>% 
  unnest()

results <- bind_rows(singleAnchor, multiAnchors)
df_home <- results %>% 
  filter(loc == "home") %>% 
  filter(type != "multifunctional")
write_csv(df_home, path = "/Users/qingqing/Dropbox/SUTD/Ate/homelocator/comparison/result_ahs.csv")
```






