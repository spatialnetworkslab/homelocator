---
title: "Ahas Method"
date: '`r format(Sys.time(), "%d %B, %Y")`'
output: 
  html_document:
    toc: true 
    toc_depth: 4  
    number_sections: true  
    theme: united  
    highlight: tango  
    toc_float: true   
    code_folding: hide
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r load_library}
library(tidyverse)
library(magrittr)
library(sf)
library(lubridate)
library(furrr)
library(gridExtra)
library(tidycensus)
library(homelocator)
```

# Load data
```{r load_data, message=FALSE, warning=FALSE}
df <- read_csv("/Users/qingqing/Dropbox/SUTD/Ate/homelocator/data/lexington-with-GEOID-2012-2017.csv") %>% 
  select(c(id, u_id, GEOID, created_at)) 

df <- df %>% 
  derive_timestamp(created_at)

# nest data 
df_nest <- df %>% 
  group_by(u_id) %>% 
  nest(.key = user_data)
head(df_nest)
```

# Data filtering 
```{r data_filtering, message=FALSE, warning=FALSE}
df_filtered <- df_nest %>% 
  summarise_by_user(counts_per_user = n(), distinct_loc_per_user = n_distinct(GEOID)) %>% 
  summarise_by_groups(vars(GEOID), 
                      vars(counts_per_loc = n(), 
                           distinct_date_per_loc = n_distinct(date))) %>% 
  arrange_var_by_group(u_id, counts_per_loc, distinct_date_per_loc) %>% 
  top_n(., 1, counts_per_loc) %>%  # get top one loc
  unnest(grouped_data) %>% 
  group_by(u_id, counts_per_user) %>% 
  nest(.key = user_data) %>% 
  summarise_by_groups(vars(GEOID, year, month), 
                      vars(distinct_day_per_month = n_distinct(day))) %>% 
  filter_var(distinct_day_per_month > 7) %>% # top one loc must has at least 7 distinct day 
  select(u_id, counts_per_user) %>% 
  unique() %>% 
  left_join(., df) %>% 
  group_by(u_id) %>% 
  nest(.key = user_data) %>% 
  summarise_by_groups(vars(GEOID, year, month, counts_per_user), 
                      vars(distinct_day_per_month = n_distinct(day))) %>% 
  filter_var(distinct_day_per_month > 2) %>% # each loc must has at least 2 distinct day 
  arrange_var(counts_per_user) %>% 
  remove_top_n(top_user_percent = 0.1) %>% # remove top 1% users  
  unnest()
head(df_filtered)
```


```{r home_ahas, message=FALSE, warning=FALSE}
time_line <- chron::times("17:00:00") %>% as.numeric()
home_ahas <- df_filtered %>% 
  add_column(time = format(created_at, format="%H:%M:%S") %>% chron::times()) %>% 
  group_by(u_id) %>% 
  nest(.key = user_data) %>% 
  summarise_by_groups(vars(GEOID),
                      vars(distinct_date_per_loc = n_distinct(date),
                           counts_per_loc = n(),
                           avg_time = mean(time),
                           sd_time = sd(time))) %>% 
  add_column(score_avg_time = if_else(avg_time > time_line, 1, 0)) %>% 
  add_column(score_sd_time = if_else(sd_time > 0.175, 1, 0)) %>% 
  add_column(score = rowSums(.[, c("score_avg_time", "score_sd_time")])) %>% 
  group_by(u_id) %>% 
  nest(.key = user_data) %>% 
  extract_home(score >= 1, distinct_date_per_loc, counts_per_loc)
write_csv(home_ahas, path = "/Users/qingqing/Dropbox/SUTD/Ate/homelocator/comparison/result_ahas.csv")
```






