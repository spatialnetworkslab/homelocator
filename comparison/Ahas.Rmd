---
title: "Ahas Method"
author: "Chen Qinqqing"
date: '`r format(Sys.time(), "%d %B, %Y")`'
output: 
  html_document:
    toc: true 
    toc_depth: 4  
    number_sections: true  
    theme: united  
    highlight: tango  
    toc_float: true   
    code_folding: hide
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r load_library}
library(tidyverse)
library(magrittr)
library(sf)
library(lubridate)
library(furrr)
library(gridExtra)
```


```{r load_data}
df <- read_csv("/Users/qingqing/Dropbox/SUTD/Ate/homelocator/data/lexington-with-GEOID-2012-2017.csv") 
df_sub <- df %>% 
  select(id, u_id, created_at, GEOID, text, screen_name) %>% 
  mutate(year = year(created_at), 
         month = month(created_at),
         day = day(created_at), 
         GEOID = as.character(GEOID)) 
head(df_sub)
#initialy, there are 95285 users 
```

```{r step1, message=FALSE, warning=FALSE}
# determing points of regular cells and separating them from random cells
## Regular cells-network cells: regularly visited by one person and from which the person has made calls on at least two different days a month, in our case, the cell treat as GEOID/location, the user should has sent tweets on the location at least two differnt days a month
## Random cells- a netwok cell: from which the one respondent has made calls on only one day a month
df_step1 <- df_sub %>% 
  group_by(u_id, GEOID, year, month, day) %>% 
  mutate(day_counts = n()) %>% 
  group_by(u_id, GEOID, year, month) %>% 
  mutate(n_day = n_distinct(day)) %>% 
  ungroup() 

regular_cells <- df_step1 %>% filter(n_day >= 2) # the number of users decreases from 95285 to 33399  (3904743tweets)
random_cells <- df_step1 %>% filter(n_day < 2)
```


```{r step2_toolow, message=FALSE, warning=FALSE}
#Regular cells are sorted by the number of days with calls, and if days overlap, by the number of calls. Here we sorted by the number of days with tweets, and if days overlap, by the number of tweets. 
options(future.globals.maxSize= 1073741824)
df_step2 <- regular_cells %>% 
  group_by(u_id, GEOID, year, month) %>% 
  mutate(month_counts = n()) %>% 
  ungroup() %>% 
  group_by(u_id) %>% 
  nest()

remove_lowUsers <- function(data){
  df <- data %>% 
    arrange(., desc(n_day), desc(month_counts)) %>% 
    select(GEOID, n_day, month_counts) %>% 
    unique() %>% 
    top_n(n=1) %>% 
    slice(1)
  if (df$n_day < 7){
    tibble::tibble(
      id = NA,
      created_at = NA,
      GEOID = NA, 
      text = NA, 
      screen_name = NA,
      year = NA, 
      month = NA, 
      day = NA, 
      day_counts = NA, 
      n_day = NA, 
      month_counts = NA)
  } else{
    data
  }
}

regular_cells <- df_step2 %>% 
  mutate(detect = future_map(data, remove_lowUsers)) %>% 
  select(-data) %>% 
  ungroup() %>% 
  unnest() %>% 
  na.omit()  #the number of users decreases from 33399 to 10401 (3547401)
```

```{r step2_toohigh, message=FALSE, warning=FALSE}
# remove top 1% users 
regular_cells <- regular_cells %>% 
  group_by(u_id) %>% 
  summarise(total_counts = n()) %>% 
  ungroup() %>% 
  arrange(., desc(total_counts)) %>% 
  slice(round(n_distinct(.$u_id)*0.01):n()) %>% 
  left_join(., regular_cells)     # the number of users decreases from 10401 to 10298 (2911498)

# df_step2_2 <- regular_cells %>% 
#   group_by(u_id) %>% 
#   nest()
# 
# remove_highUsers <- function(data){
#   df <- data %>% 
#     arrange(., desc(month_counts)) %>% 
#     select(GEOID, month_counts) %>% 
#     unique() %>% 
#     group_by(GEOID) %>% 
#     top_n(n=1, wt= month_counts) %>% 
#     ungroup() %>% 
#     top_n(n=2, wt = month_counts) %>% 
#     pull(., month_counts)
#   if(all(df > 500)){
#     tibble::tibble(
#       id = NA,
#       created_at = NA,
#       GEOID = NA, 
#       text = NA, 
#       screen_name = NA,
#       year = NA, 
#       month = NA, 
#       day = NA, 
#       day_counts = NA, 
#       n_day = NA, 
#       month_counts = NA)
#   } else{
#     data
#   }
# }
# regular_cells <- df_step2_2 %>% 
#   mutate(detect=future_map(data, remove_highUsers)) %>% 
#   select(-data) %>% 
#   ungroup() %>% 
#   unnest() %>% 
#   na.omit()
```











