---
title: "homelocator"
date: "`r Sys.Date()`"
author: Qingqing Chen, Ate Poorthuis
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{homelocator}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
devtools::load_all(".")
library(homelocator)
```

# Introduction

The `homelocator` library is designed for identifying meaningful locations for users based on the spatial and temporal features contained within the mobility data, such as social media data, mobile phone data and so on.

The main objective for developing this package is to provide a consistent framework and interface for the adoption of different approaches so that researchers are able to write structured, algorithmic 'recipes' to identify the meaningful locations according to their research requirement and able to achieve an apples-to-apples comparison across the approaches. 

We hope that through packages and libraries like the one presented here, future work that relies on the inference of meaningful locations becomes less ‘custom’ (with each researcher writing their own algorithm) but instead will use common, comparable algorithms in order to increase transparency and reproducibility in the field.


```{r echo=FALSE, results='hide', message=F}
# Load other needed libraries
library(tidyverse)
library(emo)
library(lubridate)
library(here)
```

# Test Data

To explore the basic data manipulation functions of `homelocator`, we'll use a `test_sample` dataset. 

```{r}
load(here("data/test_sample.rda"))
test_sample %>% head(3)
```

<span style="color:red">*Note:*</span> *if you use your own dataset, please make sure that you have coverted the data timestamp to your local time zone!*

# Usage

## Functions

### Validate input dataset 

The `validate_dataset()` function in `validate_datset.R` script makes sure your input dataset contains all three necessary variables: user, locaiton and timestamp. There are 4 augments in this function: 

  - `user`: name of column that holds unique identifier for each user 
  - `timestamp`: name of column that holds specific timestamp for each data point and it should be `POSIXct`
  - `location`: name of column that holds unique identifier for each location
  - `keep_other_vars`: option to keep or remove other variables of the input dataset. The default is `FALSE`


```{r}
df_validated <- validate_dataset(test_sample, user = "u_id", timestamp = "created_at", 
                                 location = "GEOID", keep_other_vars = FALSE)
df_validated %>% head(3)
```


### Nest and Unnest 

The `nest_verbose()` and `unnest_verbose()` functions in `nest.R` script work in the same way as  [nest](https://www.rdocumentation.org/packages/tidyr/versions/0.8.3/topics/nest) and [unnest](https://www.rdocumentation.org/packages/tidyr/versions/0.8.3/topics/unnest) functions in [tidyverse](https://github.com/tidyverse/tidyverse) but with extra information of elapsed runing time. 
  
  - `df`: A dataframe
  - `...`: For `nest_verbose()` refers to selected columns to nest and for `unnest_verbose()` refers to list-column to unnest.
 

```{r}
# nest data
df_nested <- nest_verbose(df_validated, c("created_at", "GEOID"))

# show nested dataframe 
df_nested %>% head(3)

# show data in nested list-column
df_nested$data[[1]] %>% head(3)

# unnest data
df_unnested <- unnest_verbose(df_nested, data)
df_unnested %>% head(3)
```


### Double nest and Double unnest

The `nest_double_nest()` and `unnest_double_nested()` functions in `nest.R` script work in the similar way as `nest_verbose()` and `unnest_verbose()` functions but they apply to nested dataframe. In another words, they map `nest` and `unnest` function to each element of a list.
  
  - `df`: A nested dataframe
  - `...`: For `nest_double_nest()` refers to selected columns to nest and for `unnest_double_nested()` refers to list-column to unnest.
 

```{r}
# double nest data
df_double_nested <- nest_double_nest(df_nested, c("created_at"))

# show double nest dataframe
df_double_nested %>% head(3)

# shou data in double nested list-column
df_double_nested$data[[1]] %>% head(3)

df_double_nested$data[[1]]$data[[1]] %>% head(3)

# unnest nested data 
df_double_unnested <- df_double_nested %>% 
  head(100) %>%  ## take first 100 rows for example
  unnest_double_nested(., data) 

# show unnest nested data 
df_double_unnested %>% head(3)
```


